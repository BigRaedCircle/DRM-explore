# Layered Emulation — Расслоенная эмуляция для анализа анти-тампер систем

⚠️ **СТАТУС ПРОЕКТА: В АКТИВНОЙ РАЗРАБОТКЕ**

Проект находится в стадии активной разработки и **пока не готов к реальному использованию**. Многие компоненты являются proof-of-concept и требуют доработки. Используйте на свой риск в исследовательских целях.

---

Проект по созданию **"дешёвой" прозрачной эмуляции** через расслоенную архитектуру с единым источником времени.

## 🎯 Ключевая идея проекта

### 1. "Сами делаем — сами анализируем" ⚖️

**Этический принцип**: Мы создаём собственные учебные анти-тамперы и анализируем их в эмуляторе.

- ✅ Создаём защиту с нуля (C/C++)
- ✅ Анализируем свой код (легально)
- ✅ Публикуем результаты (научная ценность)
- ❌ НЕ дизассемблируем коммерческие игры
- ❌ НЕ обходим чужую защиту

**Результат**: Глубокое понимание архитектуры защит без юридических рисков.

### 2. "Слоистость" = Прозрачная эмуляция по цене hook-ов 🚀

**Проблема полной эмуляции**: Эмулировать всё (CPU + ОС + железо) = 1000× замедление + сложность

**Наше решение — расслоенная эмуляция**:
```
Эмулируем ТОЛЬКО критичные слои:
├─ Слой 1: VirtualClock (единый источник времени)
├─ Слой 2: CPU (Unicorn Engine)
├─ Слой 3: MiniOS (память, потоки, syscalls)
└─ Слой 4: WinAPI (критичные функции)

Периферия = заглушки (DirectX, файлы, GUI, сеть...)
```

**Ключевой принцип: "Следуем основной ветке кода"**
- ✅ Эмулируем: CPU, время, память, проверки защиты
- ❌ Заглушки: DirectX, GUI, файлы, сеть (возвращают успех)
- 🎯 Результат: Быстро доходим до анти-тампер логики

**Преимущества**:
- ⚡ **Быстро**: 2-5× замедление вместо 1000×
- 🎯 **Прозрачно**: Все таймеры синхронизированы → анти-тампер не детектирует
- 🔧 **Просто**: Фокус на критичном, остальное — заглушки
- 🚀 **Эффективно**: Не застреваем на эмуляции DirectX/GUI

**Фишка**: Эмулируем только то, что проверяет анти-тампер. Периферия = автоматический F10.

## 🎯 Цели проекта

1. **Статический анализ** — детектирование Denuvo и других DRM в PE-файлах
2. **Расслоенная эмуляция** — "дешёвая" прозрачная эмуляция с единым временем
3. **Дифференциальный анализ** — автоматическая локализация проверок защиты
4. **Научная ценность** — публикация результатов как учебных материалов

## 📁 Структура проекта

```
.
├── README.md                   # Этот файл
├── RoadMap.md                  # План развития
├── TECHNICAL_BRIEFING.md       # Полное техническое описание
├── QUICK_START.md              # Быстрый старт
│
├── src/core/
│   ├── virtual_clock.py        # ✅ Единый источник времени
│   ├── simple_emulator.py      # ✅ Базовая эмуляция CPU
│   ├── layered_emulator.py     # ✅ Полная расслоенная эмуляция
│   ├── mini_os.py              # ✅ Виртуальное ядро ОС (память, потоки, syscalls)
│   ├── winapi_stubs.py         # ✅ Заглушки WinAPI (критичные + периферия)
│   ├── differential_analyzer.py # ✅ Дифференциальный анализ
│   └── pe_loader.py            # ✅ Загрузка PE-файлов
│
├── demos/
│   ├── test_rdtsc.py           # ✅ Тест VirtualClock
│   ├── test_mini_os.py         # ✅ Тест MiniOS (память, heap)
│   ├── test_differential.py    # ✅ Тест дифференциального анализа
│   ├── test_main_path_focus.py # ✅ Демонстрация "фокуса на основной ветке"
│   └── time_check_demo.c       # Учебный анти-тампер
│
├── denuvo-detector.py          # Детальный анализ PE (v1.0)
├── denuvo-advanced.py          # Система оценки с эвристиками
│
└── Denuvo DRM Detection Methods.txt  # Полная переписка с Qwen
```

## 🚀 Быстрый старт

### Установка зависимостей

```bash
pip install pefile unicorn-engine capstone
```

### Использование детектора

```bash
# Детальный анализ одного файла
python denuvo-detector.py game.exe

# Batch-сканирование директории
python denuvo-detector.py -d "C:/Games" -r

# Экспорт результатов
python denuvo-detector.py -d . -o results.json

# Продвинутый анализ с оценкой
python denuvo-advanced.py game.exe
```

## 📖 Документация

- **QUICK_START.md** — начни отсюда для быстрого понимания
- **TECHNICAL_BRIEFING.md** — полное техническое описание архитектуры
- **RoadMap.md** — план развития и текущий статус
- **Denuvo DRM Detection Methods.txt** — полная переписка (читай с конца!)

## 🔬 Ключевые концепции

### 1. Расслоенная эмуляция ("дешёвая" прозрачность)

**Идея**: Не эмулировать всю систему целиком, а только критичные слои.

**Сравнение подходов**:

| Подход | Что эмулируется | Замедление | Прозрачность |
|--------|-----------------|------------|--------------|
| **Полная эмуляция** | CPU + ОС + железо + периферия | 1000× | ✅ Идеальная |
| **Hook-и DLL** | Только перехват функций | 1.1× | ❌ Детектируется |
| **Расслоенная (наша)** | CPU + VirtualClock + заглушки API | 2-5× | ✅ Прозрачная |

**Почему работает**: Все таймеры (RDTSC, GetTickCount, QPC) синхронизированы через единый VirtualClock → математически консистентны → анти-тампер не видит разницы с реальным железом.

**Фишка проекта**: Эмулируем минимум для "иллюзии", остальное — заглушки. Дёшево + прозрачно!

### 2. Композиционная семантическая эквивалентность

Если каждый слой семантически эквивалентен реальному, и верхний слой видит только интерфейс нижнего, то верхний слой не может детектировать эмуляцию.

### 3. Дифференциальный анализ

Два идентичных эмулятора с разными входными параметрами → автоматическая локализация точки расхождения → понимание логики защиты.

## ✅ Текущий статус

⚠️ **ВАЖНО: Проект в активной разработке**

Система находится на стадии proof-of-concept. Базовые компоненты работают, но требуют значительной доработки для практического применения.

### Реализовано (работает)
- ✓ Детальный анализ PE-файлов (статический)
- ✓ Поиск сигнатур Denuvo/VMProtect
- ✓ Анализ энтропии и импортов
- ✓ Batch-режим и экспорт результатов
- ✓ Система оценки (0-100 баллов)
- ✅ **Этап 1: Минимальная расслоенная эмуляция** — VirtualClock + SimpleEmulator
- ✅ **Этап 4: Виртуальная ОС (MiniOS)** — память, heap, потоки, syscalls
- ✅ **Дифференциальный анализатор** — автоматическая локализация проверок
- ✅ **Периферийные заглушки** — LoadLibrary, CreateFile, MessageBox, Sleep...
- ✅ **Автогенерация API заглушек** — 442 функции из Windows SDK/DirectX SDK

### В разработке (не готово)
- 🚧 Интеграция автогенерированных заглушек с LayeredEmulator
- 🚧 Полноценная поддержка PE-файлов с защитой
- 🚧 Стабильность эмуляции на сложных программах
- 🚧 COM интерфейсы DirectX
- 🚧 Расширенная поддержка WinAPI (user32, ws2_32, gdi32)

### Архитектура (4 слоя)
```
┌─────────────────────────────────────────────────────────┐
│ СЛОЙ 4: Целевой код (PE-файлы, анти-тамперы)           │
└────────────────────┬────────────────────────────────────┘
                     │ (WinAPI вызовы)
┌────────────────────▼────────────────────────────────────┐
│ СЛОЙ 3: WinAPIStubs                                     │
│   • Критичные: GetTickCount64, HeapAlloc, VirtualAlloc │
│   • Периферия: LoadLibrary, CreateFile, MessageBox     │
│   • Стратегия: Заглушки возвращают успех               │
└────────────────────┬────────────────────────────────────┘
                     │ (Nt*/Zw* syscalls)
┌────────────────────▼────────────────────────────────────┐
│ СЛОЙ 2: MiniOS (виртуальное ядро)                      │
│   • VirtualMemoryManager (управление памятью)           │
│   • HeapManager (куча)                                  │
│   • ThreadScheduler (планировщик)                       │
│   • Syscall table (12+ системных вызовов)               │
└────────────────────┬────────────────────────────────────┘
                     │ (CPU инструкции)
┌────────────────────▼────────────────────────────────────┐
│ СЛОЙ 1: Эмуляция CPU                                    │
│   • Unicorn Engine (x86-64)                             │
│   • VirtualClock (единый источник времени)              │
│   • RDTSC/SYSCALL перехват                              │
└─────────────────────────────────────────────────────────┘
```

### Proof of Concept — ДОКАЗАН! 🎉
```bash
# Тест 1: RDTSC работает через VirtualClock
$ python demos/test_rdtsc.py
[OK] SUCCESS! Время консистентно: 2027 виртуальных тактов

# Тест 2: MiniOS управляет памятью
$ python demos/test_mini_os.py
[OK] ✓✓✓ ALL TESTS PASSED ✓✓✓

# Тест 3: Дифференциальный анализ локализует проверки
$ python demos/test_differential.py
[OK] SUCCESS! Расхождение найдено на шаге 1

# Тест 4: Фокус на основной ветке
$ python demos/test_main_path_focus.py
[OK] ✓✓✓ ПРИНЦИП ДОКАЗАН!
```

### В бэклоге
- 📋 Модель кэша (Этап 2, опционально)
- 📋 Углубление дифференциального анализатора (бинарный поиск, визуализация)
- 📋 Тестирование на реальных PE-файлах с защитой

## ⚖️ Этические принципы

### ✅ Разрешено (наш подход)
- **Создавать** учебные анти-тамперы с нуля
- **Анализировать** собственный код
- **Публиковать** результаты как научные материалы
- **Использовать** для легальных целей (безопасность, исследования)

### ❌ Запрещено (не делаем)
- Дизассемблировать коммерческие игры
- Обходить чужую защиту
- Создавать инструменты для пиратства
- Нарушать лицензионные соглашения

### 💡 Философия: "Сами делаем — сами анализируем"

Лучший способ понять систему защиты — **построить её самому**. Именно так работают:
- Исследователи из Hex-Rays (создатели IDA Pro)
- Команды Google Project Zero
- Разработчики легальных инструментов анализа (Ghidra, Binary Ninja)

Мы не "взламываем" чужую защиту — мы **строим и разбираем свою**. Это этично, законно и профессионально уважаемо.

## 📊 Примеры использования

### Детальный анализ

```bash
$ python denuvo-detector.py Outlaws.exe

[БАЗОВАЯ ИНФОРМАЦИЯ]
  Архитектура: 0x8664 (IMAGE_FILE_MACHINE_AMD64)
  Секций: 19
  SizeOfImage: 532,418,560 байт (507.75 МБ)

[СЕКЦИИ PE-ФАЙЛА]
#   Имя          RVA          Размер     Права    Энтропия
7   .ecode       0xa0cb000    347MB      XRW      6.75

[ПОИСК СТРОКОВЫХ СИГНАТУР]
  [+] 'denuvo' в секции '.ecode'
  [+] 'antitamper' в секции '.ecode'

[ИТОГ] ✓✓✓ DENUVO ОБНАРУЖЕН ✓✓✓
```

### Продвинутый анализ

```bash
$ python denuvo-advanced.py game.exe

[+] Анализ: game.exe

  [✓] Секции
  [✓] Сигнатуры
  [✓] Энтропия
  [○] Импорты
  [○] Временная метка
  [○] Точка входа

[ОЦЕНКА] Баллов: 85/100

[ДОКАЗАТЕЛЬСТВА]
  1. Сигнатура 'denuvo' в .ecode
  2. Огромная исполняемая секция .ecode (331 МБ)
  3. Высокая энтропия 6.75 в .ecode

[ВЕРДИКТ] DENUVO ОБНАРУЖЕН (уверенность: высокая)
```

## 🛠️ Разработка

### Следующие шаги

1. Прочитай `QUICK_START.md`
2. Изучи `TECHNICAL_BRIEFING.md`
3. Начни с Этапа 1 — минимальной расслоенной эмуляции

### Структура кода (планируется)

```
src/
├── core/
│   ├── virtual_clock.py        # Единый источник времени
│   ├── layered_emulator.py     # Расслоенная эмуляция
│   └── cache_model.py          # Модель кэш-иерархии
├── analysis/
│   ├── differential.py         # Дифференциальный анализатор
│   └── visualizer.py           # Визуализация результатов
└── demos/
    ├── time_check_demo.c       # Учебный анти-тампер
    └── vm_demo.c               # Виртуализация кода
```

## 📚 Ресурсы

### Теория
- "Computability and Logic" (Boolos, Burgess, Jeffrey)
- "Virtual Machines" (Smith, Nair)

### Практика
- "Practical Binary Analysis" (Andriesse)
- Unicorn Engine Documentation
- angr Documentation

### Этика
- "The Hacker Ethic" (Himanen)

## 🤝 Вклад

После завершения основных этапов проект будет открыт на GitHub с полной документацией и примерами.

## 📄 Лицензия

Проект создаётся для образовательных и научных целей. Использование только в легальных рамках.

---

**Философия**: Глубокое понимание через создание и анализ собственных систем защиты. Легально, этично, научно ценно.

**Помни**: Это не "взлом" — это наука о вычислениях в чистом виде.
